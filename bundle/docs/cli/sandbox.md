# Пісочниця (Sandboxing) у Gemini CLI

Цей документ містить посібник із використання пісочниці в Gemini CLI, включаючи
вимоги, швидкий старт та налаштування.

## Попередні вимоги

Перед використанням пісочниці вам потрібно встановити Gemini CLI:

```bash
npm install -g santoni-star/gemini-ua
```

Щоб перевірити встановлення:

```bash
gemini-ua --version
```

## Огляд пісочниці

Пісочниця ізолює потенційно небезпечні операції (такі як команди оболонки або
зміна файлів) від вашої хост-системи, створюючи бар'єр безпеки між операціями ШІ
та вашим середовищем.

Переваги пісочниці включають:

- **Безпека**: Запобігання випадковому пошкодженню системи або втраті даних.
- **Ізоляція**: Обмеження доступу до файлової системи лише каталогом проекту.
- **Узгодженість**: Гарантія відтворюваності середовища на різних системах.
- **Захист**: Зниження ризику при роботі з ненадійним кодом або
  експериментальними командами.

## Методи пісочниці

Ваш ідеальний метод пісочниці може відрізнятися залежно від платформи та
бажаного рішення для контейнеризації.

### 1. macOS Seatbelt (тільки для macOS)

Легка, вбудована пісочниця з використанням `sandbox-exec`.

**Профіль за замовчуванням**: `permissive-open` — обмежує запис за межами
каталогу проекту, але дозволяє більшість інших операцій.

### 2. На основі контейнерів (Docker/Podman)

Кросплатформна пісочниця з повною ізоляцією процесів.

**Примітка**: Потрібна локальна збірка образу пісочниці або використання
опублікованого образу.

## Швидкий старт

```bash
# Увімкнути пісочницю за допомогою прапорця команди
gemini-ua -s -p "проаналізуй структуру коду"

# Використовувати змінну середовища
export GEMINI_SANDBOX=true
gemini-ua -p "запусти тести"

# Налаштувати в settings.json
{
  "tools": {
    "sandbox": "docker"
  }
}
```

## Налаштування

### Увімкнення пісочниці (у порядку пріоритету)

1. **Прапорець команди**: `-s` або `--sandbox`
2. **Змінна середовища**: `GEMINI_SANDBOX=true|docker|podman|sandbox-exec`
3. **Файл налаштувань**: `"sandbox": true` в об'єкті `tools` вашого файлу
   `settings.json`.

### Профілі macOS Seatbelt

Вбудовані профілі (встановлюються через змінну `SEATBELT_PROFILE`):

- `permissive-open` (типово): Обмеження запису, мережа дозволена.
- `permissive-closed`: Обмеження запису, без мережі.
- `permissive-proxied`: Обмеження запису, мережа через проксі.
- `restrictive-open`: Суворі обмеження, мережа дозволена.
- `restrictive-closed`: Максимальні обмеження.

### Власні прапорці пісочниці

Для пісочниці на основі контейнерів ви можете додати власні прапорці до команди
`docker` або `podman`, використовуючи змінну середовища `SANDBOX_FLAGS`. Це
корисно для складних конфігурацій, наприклад, вимкнення функцій безпеки для
специфічних випадків.

**Приклад (Podman)**:

Щоб вимкнути маркування SELinux для монтування томів:

```bash
export SANDBOX_FLAGS="--security-opt label=disable"
```

### Обробка UID/GID у Linux

Пісочниця автоматично керує правами користувача в Linux. Ви можете змінити цю
поведінку:

```bash
export SANDBOX_SET_UID_GID=true   # Примусово використовувати UID/GID хоста
export SANDBOX_SET_UID_GID=false  # Вимкнути мапінг UID/GID
```

## Усунення несправностей

### Поширені проблеми

**"Operation not permitted"**

- Операція потребує доступу за межами пісочниці.
- Спробуйте більш вільний профіль або додайте точки монтування.

**Відсутні команди**

- Додайте їх у власний Dockerfile.
- Встановіть через `sandbox.bashrc`.

**Проблеми з мережею**

- Перевірте, чи дозволяє профіль пісочниці доступ до мережі.
- Перевірте конфігурацію проксі.

### Режим налагодження

```bash
DEBUG=1 gemini-ua -s -p "команда для налагодження"
```

## Нотатки щодо безпеки

- Пісочниця знижує, але не усуває всі ризики.
- Використовуйте найбільш обмежений профіль, який дозволяє виконувати вашу
  роботу.
- Накладні витрати контейнера мінімальні після першої збірки.
- GUI-програми можуть не працювати в пісочницях.

## Пов'язана документація

- [Налаштування](../get-started/configuration.md): Повний список параметрів.
- [Команди](./commands.md): Доступні команди.
- [Усунення несправностей](../troubleshooting.md): Загальні поради.
